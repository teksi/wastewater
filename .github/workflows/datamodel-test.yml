name: üêò Datamodel | Tests

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - main
    paths:
      - datamodel/**
      - '.github/workflows/datamodel-test.yml'
  pull_request:
    branches:
      - main
    paths:
      - datamodel/**
      - '.github/workflows/datamodel-test.yml'
  workflow_dispatch:


jobs:
  datamodel-tests:
    name: Run unit tests on datamodel
    runs-on: ubuntu-24.04

    env:
      DOCKER_TAG: teksi/tww:unstable
      DB_NAME: tww
      PG_SERVICE: pg_tww
      DEMO_DATA: Aletsch

    strategy:
      fail-fast: false
      matrix:
        include:
        - modification_ci: false
          modification_agxx: false

        - modification_ci: true
          modification_agxx: false

        - modification_ci: false
          modification_agxx: true

    steps:
      - uses: actions/checkout@v5

      - name: "build dockerfile"
        run: |
          docker build -f datamodel/.docker/Dockerfile \
            --build-arg RUN_TEST=True \
            --build-arg DB_NAME=${DB_NAME} \
            --build-arg PG_SERVICE=${PG_SERVICE} \
            --build-arg TEST_PACKAGES="${TEST_PACKAGES}" \
            --tag ${DOCKER_TAG} .

      - name: Initialize container
        run: |
          docker run -d -p 5432:5432 -v $(pwd):/usr/src --name pum_db_container ${DOCKER_TAG}
          until docker exec pum_db_container pg_isready -U postgres; do
            echo "Waiting for PostgreSQL to be ready..."
            sleep 2
          done
          # create the database
          docker exec pum_db_container sh -c "createdb ${DB_NAME}"
          docker exec pum_db_container \
              pum -vvv -s ${PG_SERVICE} -d datamodel install \
              -p modification_ci ${{ matrix.modification_ci}} \
              -p modification_agxx ${{ matrix.modification_agxx}} \
              -p SRID 2056 --roles --grant

      - name: Run tests
        run:  docker exec pum_db_container pytest datamodel

      - name: Docker logs
        if: failure()
        run: docker logs pum_db_container

  static-tests:
    name: Run static tests on datamodel
    runs-on: ubuntu-24.04

    steps:
    - uses: actions/checkout@v5
    - run: ./datamodel/test/static_tests.sh
